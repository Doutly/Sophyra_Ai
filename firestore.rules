rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() &&
             (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
              request.auth.token.email == 'mani@sophyra.in');
    }

    // Helper function to check if user is HR
    function isHR() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'hr' &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isApproved == true;
    }

    // Users collection
    match /users/{userId} {
      // Allow read if user owns the document or is admin
      allow read: if isOwner(userId) || isAdmin();

      // Allow create during signup for own user document
      allow create: if isOwner(userId) &&
                      request.resource.data.uid == request.auth.uid &&
                      request.resource.data.email == request.auth.token.email;

      // Allow update if user owns the document
      // Prevent role changes unless done by admin
      allow update: if isOwner(userId) &&
                      (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'isApproved']) ||
                       isAdmin());

      // Only admins can delete users
      allow delete: if isAdmin();
    }

    // Interview sessions
    match /sessions/{sessionId} {
      allow read: if isOwner(resource.data.userId) || isAdmin() || isHR();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    // Interview reports
    match /reports/{reportId} {
      allow read: if isOwner(resource.data.userId) || isAdmin() || isHR();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    // Resume data
    match /resumes/{resumeId} {
      allow read: if isOwner(resource.data.userId) || isAdmin() || isHR();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId);
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    // Shared reports (public access)
    match /shares/{shareToken} {
      allow read: if true; // Public read access
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    // Mock interview requests
    match /mockInterviewRequests/{requestId} {
      // Anyone authenticated can read requests
      allow read: if isAuthenticated();

      // Candidates can create their own requests
      allow create: if isAuthenticated() && request.resource.data.user_id == request.auth.uid;

      // Candidates can update their own requests (if not yet approved)
      // Admins can update any request (approve, reject, assign HR)
      // HR can update requests they've claimed or that are assigned to them
      allow update: if isOwner(resource.data.user_id) ||
                       isAdmin() ||
                       (isHR() && (
                         resource.data.claimed_by == request.auth.uid ||
                         resource.data.assigned_hr_id == request.auth.uid ||
                         (!exists(/databases/$(database)/documents/mockInterviewRequests/$(requestId)) || resource.data.booking_status == 'unclaimed')
                       ));

      // Only admins can delete requests
      allow delete: if isAdmin();
    }

    // Admin operations - list all users
    match /users/{userId} {
      allow list: if isAdmin() || isHR();
    }

    // Deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
